<!doctype html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mini Shop | Premium Deals</title>
  <link rel="stylesheet" href="/Comercials_Show/Comercial.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" />
</head>

<body>
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    // Unified Key - Must match all other pages
    const GLOBAL_CART_KEY = "miniShop_Universal_Cart";
    const FALLBACK_IMAGE = "https://via.placeholder.com/400x300?text=Image+Not+Found";

    function CountdownTimer({ hours = 12 }) {
      const [time, setTime] = useState({ h: hours, m: 45, s: 0 });
      useEffect(() => {
        const timer = setInterval(() => {
          setTime((prev) => {
            if (prev.s > 0) return { ...prev, s: prev.s - 1 };
            if (prev.m > 0) return { ...prev, m: prev.m - 1, s: 59 };
            if (prev.h > 0) return { h: prev.h - 1, m: 59, s: 59 };
            return prev;
          });
        }, 1000);
        return () => clearInterval(timer);
      }, []);
      return (
        <span>
          {String(time.h).padStart(2, "0")}h {String(time.m).padStart(2, "0")}m {String(time.s).padStart(2, "0")}s
        </span>
      );
    }

    function Shop() {
      const [products, setProducts] = useState([]);
      const [isCartOpen, setIsCartOpen] = useState(false);
      const [activeAd, setActiveAd] = useState(0);

      // --- 1. PERSISTENT GLOBAL CART ---
      const [cart, setCart] = useState(() => {
        const saved = localStorage.getItem(GLOBAL_CART_KEY);
        return saved ? JSON.parse(saved) : [];
      });

      const ads = [
        { tag: "SEASON SALE", title: "BIG SALE EVENT", desc: "Huge discounts on everything.", color: "gold", filter: "all" },
        { tag: "EXCLUSIVE", title: "FLASH DEAL", desc: "Blink and you'll miss these drops.", color: "red", filter: "flash" },
        { tag: "NEW", title: "PREMIUM SELECTION", desc: "Special launch offers.", color: "blue", filter: "offer" },
      ];

      // --- 2. MULTI-TAB SYNC ---
      useEffect(() => {
        const handleStorageChange = (e) => {
          if (e.key === GLOBAL_CART_KEY) {
            setCart(JSON.parse(e.newValue || "[]"));
          }
        };
        window.addEventListener("storage", handleStorageChange);
        return () => window.removeEventListener("storage", handleStorageChange);
      }, []);

      // --- 3. SAVE TO LOCALSTORAGE ---
      useEffect(() => {
        localStorage.setItem(GLOBAL_CART_KEY, JSON.stringify(cart));
      }, [cart]);

      // --- 4. FETCH DATA ---
      useEffect(() => {
        const jsonPath = "/Comercials_Show/Big_Deal/Com_BigDeal.json";
        const imgFolder = "Big_Deal";

        fetch(jsonPath)
          .then((res) => {
            if (!res.ok) throw new Error(`Could not find JSON at ${jsonPath}`);
            return res.json();
          })
          .then((data) => {
            const processed = data.map((p) => ({
              ...p,
              category: "big_deal",
              image: p.image && !p.image.startsWith("http")
                ? `/Comercials_Show/${imgFolder}/${p.image}`
                : p.image,
            }));
            setProducts(processed);
          })
          .catch((err) => console.error("Fetch Error:", err));
      }, []);

      // Ads Rotation
      useEffect(() => {
        const timer = setInterval(() => setActiveAd(p => (p + 1) % ads.length), 5000);
        return () => clearInterval(timer);
      }, []);

      // --- 5. UNIFIED CART ACTIONS ---
      const addToCart = (product) => {
        setCart((prev) => {
          const exists = prev.find((item) => item.id === product.id && item.name === product.name);
          if (exists) {
            return prev.map((item) =>
              item.id === product.id && item.name === product.name
                ? { ...item, quantity: item.quantity + 1 }
                : item
            );
          }
          return [...prev, { ...product, quantity: 1 }];
        });
        setIsCartOpen(true);
      };

      const updateQuantity = (id, name, delta) => {
        setCart((prev) =>
          prev.map((item) => {
            if (item.id === id && item.name === name) {
              const newQty = item.quantity + delta;
              return newQty > 0 ? { ...item, quantity: newQty } : item;
            }
            return item;
          })
        );
      };

      const removeFromCart = (id, name) => {
        setCart((prev) => prev.filter((i) => !(i.id === id && i.name === name)));
      };

      const applyFilter = (type) => {
        const section = document.getElementById("shop-main");
        if (section) section.scrollIntoView({ behavior: "smooth" });
      };

      const totalPrice = cart.reduce((sum, item) => sum + (parseFloat(item.price) * item.quantity), 0);
      const totalItems = cart.reduce((sum, item) => sum + item.quantity, 0);

      return (
        <div className="container">
          {/* Sidebar Cart UI */}
          <div className={`cart-overlay ${isCartOpen ? "show" : ""}`} onClick={() => setIsCartOpen(false)}></div>
          <div className={`cart-sidebar ${isCartOpen ? "open" : ""}`}>
            <div className="cart-header">
              <h2>My Bag ({totalItems})</h2>
              <button className="close-cart" onClick={() => setIsCartOpen(false)}>&times;</button>
            </div>

            <div className="cart-items">
              {cart.length === 0 ? (
                <div className="empty-msg">Your bag is empty</div>
              ) : (
                cart.map((item, index) => (
                  <div key={`${item.id}-${item.name}-${index}`} className="cart-item">
                    <img src={item.image} alt={item.name} onError={(e) => e.target.src = FALLBACK_IMAGE} />
                    <div className="cart-item-info">
                      <h4>{item.name}</h4>
                      <p className="item-price">${Number(item.price).toFixed(2)}</p>
                      <div className="qty-controls" style={{ display: 'flex', alignItems: 'center', gap: '10px', marginTop: '5px' }}>
                        <button className="qty-btn" onClick={() => updateQuantity(item.id, item.name, -1)}>-</button>
                        <span className="qty-number" style={{ fontWeight: 'bold' }}>{item.quantity}</span>
                        <button className="qty-btn" onClick={() => updateQuantity(item.id, item.name, 1)}>+</button>
                      </div>
                      <button className="remove-btn" onClick={() => removeFromCart(item.id, item.name)}>Remove</button>
                    </div>
                  </div>
                ))
              )}
            </div>

            <div className="cart-footer">
              <div className="total-row">
                <span>Total:</span>
                <span>${totalPrice.toFixed(2)}</span>
              </div>
              <button className="checkout-btn" disabled={cart.length === 0}
                onClick={() => Swal.fire("Success", "Connecting to Secure Checkout...", "success")}>
                Checkout Now
              </button>
            </div>
          </div>

          <header className="header-wrapper">
            <nav className="header">
              <div className="logo-section" onClick={() => applyFilter("all")}>
                <h1>üõçÔ∏è MiniShop</h1>
                <p>Quality You Can Trust</p>
              </div>

              <div className="header-actions">
                <button className="nav-btn bf-btn" onClick={() => applyFilter("all")}>
                  üñ§ Premium Deals
                </button>
                <div className="cart-container" onClick={() => setIsCartOpen(true)}>
                  <span className="cart-icon">üõí</span>
                  <span className="cart-count">{totalItems}</span>
                </div>
              </div>
            </nav>

            <div className="ads-carousel">
              {ads.map((ad, index) => (
                <div key={index} className={`ad-slide ${activeAd === index ? "active" : ""} slide-${ad.color}`}>
                  <div className="ad-content">
                    <div className="ad-text">
                      <span className="promo-tag">{ad.tag}</span>
                      <h2>{ad.title}</h2>
                      <p>{ad.desc}</p>
                      <button className="ad-cta" onClick={() => applyFilter(ad.filter)}>
                        Shop This Deal ‚Üí
                      </button>
                    </div>
                    <div className="ad-visual">
                      <div className="timer-box">
                        Ends In: <br /> <CountdownTimer hours={24} />
                      </div>
                    </div>
                  </div>
                </div>
              ))}
            </div>
          </header>

          <main className="products-grid" id="shop-main">
            {products.length === 0 ? (
              <div className="empty-state">Loading premium deals...</div>
            ) : (
              products.map((p) => (
                <div key={p.id} className="product-card">
                  {p.offer && <div className="offer-badge">{p.offer}</div>}
                  <div className="product-image-container">
                    <img src={p.image} alt={p.name} onError={(e) => e.target.src = FALLBACK_IMAGE} />
                  </div>
                  <div className="product-info">
                    <h3 className="product-title">{p.name}</h3>
                    <div className="price-section">
                      <span className="current-price">${Number(p.price).toFixed(2)}</span>
                      {p.oldPrice && (
                        <span className="old-price">${Number(p.oldPrice).toFixed(2)}</span>
                      )}
                    </div>
                    <button className="add-to-cart-btn" onClick={() => addToCart(p)}>
                      Add to Cart
                    </button>
                  </div>
                </div>
              ))
            )}
          </main>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById("root")).render(<Shop />);
  </script>
</body>

</html>