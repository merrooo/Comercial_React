<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Special Offers Shop</title>
  <link rel="stylesheet" href="/Comercials_Show/Comercial.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
  <style>
    .badge {
      background:red; color:white; padding:2px 6px; border-radius:50%; font-size:12px; position:absolute; top:-8px; right:-10px;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <!-- React & Babel -->
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <script type="text/babel">
    const { useState, useEffect } = React;

    function ProductCard({ product, onAddToCart }) {
      return (
        <div className="product-card">
          {product.offer && <div className="offer-badge">{product.offer}</div>}
          <div className="product-image-container">
            <img
              src={product.image}
              alt={product.name}
              onError={e => e.target.src="https://via.placeholder.com/250x180?text=No+Image"}
            />
          </div>
          <div className="product-info">
            <h3>{product.name}</h3>
            <p>${product.price.toFixed(2)}</p>
            <button className="add-to-cart-btn" onClick={() => onAddToCart(product)}>Add to Cart</button>
          </div>
        </div>
      );
    }

    function Shop({ jsonFile, shopTitle }) {
      const [products, setProducts] = useState([]);
      const [cart, setCart] = useState([]);
      const [address, setAddress] = useState("");
      const [phone, setPhone] = useState("");

      useEffect(() => {
        fetch(jsonFile)
          .then(res => res.json())
          .then(data => {
            const processed = data.map(p => ({
              ...p,
              image: p.image && !p.image.startsWith("http") ? `/images/${p.image}` : p.image
            }));
            setProducts(processed);
          })
          .catch(err => console.error("Error loading products:", err));
      }, [jsonFile]);

      const addToCart = (product) => {
        setCart(prev => {
          const found = prev.find(p => p.id === product.id);
          if (found) return prev.map(p => p.id === product.id ? {...p, quantity: p.quantity+1} : p);
          return [...prev, {...product, quantity:1}];
        });
      };

      const openCartModal = () => {
        const totalPrice = cart.reduce((sum,item)=>sum+item.price*item.quantity,0).toFixed(2);
        let html = `<div style="text-align:left;">`;
        if(cart.length===0){
          html += `<p style="text-align:center;color:#666;padding:20px;">Your cart is empty</p>`;
        } else {
          cart.forEach(item=>{
            html += `
              <div style="display:flex;justify-content:space-between;margin-bottom:12px;padding:12px;background:#f9f9f9;border-radius:8px;">
                <div>
                  <strong>${item.name}</strong><br/>
                  <small>$${item.price.toFixed(2)} each</small>
                  <div style="display:flex;gap:8px;margin-top:5px;">
                    <button onclick="window.decreaseQty(${item.id})">‚àí</button>
                    <span>${item.quantity}</span>
                    <button onclick="window.increaseQty(${item.id})">+</button>
                  </div>
                </div>
                <div>
                  <strong style="color:#1e88e5;">$${(item.price*item.quantity).toFixed(2)}</strong><br/>
                  <button onclick="window.removeFromCart(${item.id})">Remove</button>
                </div>
              </div>
            `;
          });
          html += `<p style="font-weight:bold;">Total: $${totalPrice}</p>`;
        }
        html += `
          <div style="margin-top:10px;">
            <label>Address</label><br/>
            <textarea id="swal-address" style="width:100%;min-height:60px;">${address}</textarea>
            <label>Phone</label><br/>
            <input id="swal-phone" type="text" style="width:100%;" value="${phone}" />
          </div>
        </div>`;

        Swal.fire({
          title: `üõí ${shopTitle}`,
          html,
          showConfirmButton:true,
          confirmButtonText:"Place Order",
          showCancelButton:cart.length>0,
          cancelButtonText:"Close",
          didOpen: () => {
            window.increaseQty = id => { setCart(prev=>prev.map(p=>p.id===id?{...p,quantity:p.quantity+1}:p)); setTimeout(openCartModal,100);}
            window.decreaseQty = id => { setCart(prev=>prev.map(p=>p.id===id?{...p,quantity:p.quantity-1}:p).filter(p=>p.quantity>0)); setTimeout(openCartModal,100);}
            window.removeFromCart = id => { setCart(prev=>prev.filter(p=>p.id!==id)); setTimeout(openCartModal,100);}
          },
          preConfirm: () => {
            const newAddr = document.getElementById("swal-address").value;
            const newPhone = document.getElementById("swal-phone").value;
            if(!newAddr.trim()){ Swal.showValidationMessage("Enter address"); return false; }
            if(!newPhone.trim()){ Swal.showValidationMessage("Enter phone"); return false; }
            return { newAddr, newPhone };
          }
        }).then(result=>{
          if(result.isConfirmed){
            setAddress(result.value.newAddr);
            setPhone(result.value.newPhone);
            setCart([]);
            Swal.fire("‚úÖ Order Placed Successfully!","","success");
          }
        });
      };

      const totalQty = cart.reduce((sum,item)=>sum+item.quantity,0);

      return (
        <>
          <header className="header">
            <div>
              <h1>üõçÔ∏è {shopTitle}</h1>
              <p>Check out our exclusive offers!</p>
            </div>
            <div className="cart-bag" style={{position:"relative",cursor:"pointer"}} onClick={openCartModal}>
              üõí Cart {totalQty>0 && <span className="badge">{totalQty}</span>}
            </div>
          </header>

          <main>
            <div className="products-grid">
              {products.length===0 ? <p>Loading products...</p> : products.map(p=>(
                <ProductCard key={p.id} product={p} onAddToCart={addToCart}/>
              ))}
            </div>
            <button className="add-custom-item-btn">
              <a href="additem.html" style={{color:"white",textDecoration:"none"}}>‚ûï Add Your Own Item</a>
            </button>
          </main>

          <footer>
            ¬© 2024 {shopTitle}. All rights reserved.
          </footer>
        </>
      );
    }

    // Render the second shop page
    ReactDOM.createRoot(document.getElementById("root")).render(
      <Shop jsonFile="/Comercials_Show/SpecialOffers.json" shopTitle="Special Offers Shop" />
    );
  </script>
</body>
</html>
